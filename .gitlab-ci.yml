verify:
  image: maven:3.8-openjdk-17
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
  stage: test
  script:
    - mvn spotless:check
    - mvn verify -s ci_settings.xml -Dmaven.wagon.http.ssl.insecure=true
  artifacts:
    when: always
    reports:
      junit:
        - ./**/target/surefire-reports/TEST-*.xml
        - ./**/target/failsafe-reports/TEST-*.xml
  tags: [docker]
  rules:
    # Run on changes to everything except the documentation
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        paths:
          - .gitlab-ci.yml
          - ./*.xml
          - ./*.json
          - cli/**/*
          - core/**/*
          - operator/**/*
          - relays/**/*
          - test/**/*
          - webhooks/**/*
      allow_failure: true

cli:
  image:
    name: quay.io/quarkus/ubi-quarkus-graalvmce-builder-image:22.3-java17
    entrypoint: ["/bin/sh", "-c"]
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
  stage: build
  script:
    - ./mvnw clean package -pl cli -am -Pnative -s ci_settings.xml -Dmaven.wagon.http.ssl.insecure=true -Dnative-image.xmx=4g
    - mv ./cli/target/agogosctl-runner ./cli/target/agogosctl
  artifacts:
    paths:
      - cli/target/agogosctl
  tags: [docker]
  rules:
    # Run on changes to everything except the documentation
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - ./*.xml
          - ./*.json
          - cli/**/*
          - core/**/*
          - node_modules/**/*
          - operator/**/*
          - relays/**/*
          - test/**/*
          - webhooks/**/*
      allow_failure: true

docs:
  image: antora/antora:2.3.4
  stage: test
  script:
    - npm i
    - GIT_CREDENTIALS=$GIT_CREDENTIALS NODE_TLS_REJECT_UNAUTHORIZED=0 antora --fetch --to-dir public antora-playbook.yml
  artifacts:
    paths:
      - public
  tags: [docker]
  rules:
    # Only run on changes to the documentation
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        paths:
          - gulpfile.js
          - antora*.yml
          - docs/*.yml
          - docs/**/*
      allow_failure: true

pages:
  image: antora/antora:2.3.4
  stage: deploy
  script:
    - npm i
    - NODE_TLS_REJECT_UNAUTHORIZED=0 antora --fetch --to-dir public antora-playbook.yml
  artifacts:
    paths:
      - public
  tags: [docker]
  rules:
    # Only run on changes to the documentation
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - gulpfile.js
          - antora*.yml
          - docs/*.yml
          - docs/**/*
      allow_failure: true
