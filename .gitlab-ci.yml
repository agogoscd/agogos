validate:
  image: registry.access.redhat.com/ubi9/nodejs-18:latest
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
  stage: test
  script:
    - npm install -g pajv
    - cd /tmp
    - git clone gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.cee.redhat.com:gallen/extensions-internal.git
    - git branch AGOGOS-400
  tags: [docker]

verify:
  image: registry.access.redhat.com/ubi9/openjdk-17:latest
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
  stage: test
  script:
    - mvn spotless:check
    - mvn verify -s ci_settings.xml -Dmaven.wagon.http.ssl.insecure=true
  artifacts:
    when: always
    reports:
      junit:
        - ./**/target/surefire-reports/TEST-*.xml
        - ./**/target/failsafe-reports/TEST-*.xml
  tags: [docker]
  rules:
    # Run on changes to everything except the documentation
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        paths:
          - .gitlab-ci.yml
          - ./*.xml
          - ./*.json
          - cli/**/*
          - core/**/*
          - operator/**/*
          - relays/**/*
          - test/**/*
          - webhooks/**/*

cli:
  image:
    name: quay.io/quarkus/ubi-quarkus-graalvmce-builder-image:22.3-java17
    entrypoint: ["/bin/sh", "-c"]
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
  stage: build
  script:
    - ./mvnw clean package -pl cli -am -Pnative -s ci_settings.xml -Dmaven.wagon.http.ssl.insecure=true -Dnative-image.xmx=4g
    - mv ./cli/target/agogosctl-runner ./cli/target/agogosctl
  artifacts:
    paths:
      - cli/target/agogosctl
  tags: [docker]
  rules:
    # Run on changes to everything except the documentation
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - ./*.xml
          - ./*.json
          - cli/**/*
          - core/**/*
          - node_modules/**/*
          - operator/**/*
          - relays/**/*
          - test/**/*
          - webhooks/**/*

webhooks:
  image:
    name: quay.io/quarkus/ubi-quarkus-graalvmce-builder-image:22.3-java17
    entrypoint: ["/bin/sh", "-c"]
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    MAVEN_MIRROR_URL: "https://agogos-nexus.apps.ocp4.prod.psi.redhat.com/repository/maven-public"
    KUBERNETES_CPU_REQUEST: "1"
    KUBERNETES_CPU_LIMIT: "2"
    KUBERNETES_MEMORY_REQUEST: "3Gi"
    KUBERNETES_MEMORY_LIMIT: "6Gi"

  stage: build
  script:
    - ./mvnw install -pl webhooks -am -Pnative -Dquarkus.container-image.build=true -Dquarkus.container-image.push=true -Dquarkus.native.native-image-xmx=4g
  tags:
    - native-images
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - core/**/*
          - webhooks/**/*

docs:
  image: registry.access.redhat.com/ubi9/nodejs-18-minimal:latest
  stage: test
  script:
    - npm i
    - >
      GIT_CREDENTIALS=$GIT_CREDENTIALS NODE_TLS_REJECT_UNAUTHORIZED=0
      npx antora --fetch --to-dir public antora-playbook-local.yml
  artifacts:
    paths:
      - public
  tags: [docker]
  rules:
    # Only run on changes to the documentation
    # and on merge request changes
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        paths:
          - gulpfile.js
          - antora*.yml
          - docs/*.yml
          - docs/**/*

pages:
  image: registry.access.redhat.com/ubi9/nodejs-18-minimal:latest
  stage: deploy
  script:
    - npm i
    - >
      GIT_CREDENTIALS=$GIT_CREDENTIALS NODE_TLS_REJECT_UNAUTHORIZED=0
      npx antora --fetch --to-dir public antora-playbook.yml
  artifacts:
    paths:
      - public
  tags: [docker]
  rules:
    # Only run on changes to the documentation
    # and when a merge request has been merged
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - gulpfile.js
          - antora*.yml
          - docs/*.yml
          - docs/**/*

lint:commit:
  image: registry.access.redhat.com/ubi9/nodejs-18-minimal:latest
  stage: test
  script:
    - npm i --loglevel silent
    - echo "${CI_MERGE_REQUEST_TITLE}" | npx commitlint --config ${CI_PROJECT_DIR}/.commitlintrc.js
  tags: [docker]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
